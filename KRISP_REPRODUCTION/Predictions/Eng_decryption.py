import json
import os
import matplotlib.pyplot as plt
import matplotlib.image as mpimg
import textwrap


# --- CONFIGURATION ---
# 1. Path to your prediction results (generated by mmf_predict)
#    (Check your logs for the exact path, it's usually in ./save/.../reports/)
pred_file = "/data1/souradeepd/Krisp/mmf/Predictions/save/okvqa_krisp_29402777/reports/okvqa_run_test_2025-11-23T09:52:21.json"

# 2. Path to the OK-VQA Questions file (MMF downloaded this to your data dir)
#    It is usually in: <MMF_DATA_DIR>/datasets/okvqa/defaults/annotations/
#    You need the one corresponding to your split (e.g., OpenEnded_mscoco_val2014_questions.json or similar)
questions_file = "/data1/souradeepd/Caches/torch/mmf/data/datasets/okvqa/defaults/annotations/annotations/OpenEnded_mscoco_val2014_questions.json"

# 3. Path to your COCO Images (Where the images are actually stored)
#    Adjust this to where your COCO images live
image_root_dir = "/data1/souradeepd/Caches/torch/mmf/data/datasets/okvqa/defaults/annotations/annotations/coco/images/val2014"

def visualize_data():
    # 1. Load Data
    print("Loading data...")
    with open(pred_file, 'r') as f:
        preds = json.load(f)
    pred_map = {item['question_id']: item['answer'] for item in preds}

    # NOTE: If you had encoding issues before, try adding encoding='latin-1' below
    with open(questions_file, 'r') as f:
        q_data = json.load(f)
    
    questions_list = q_data.get('questions', q_data)

    # 2. Setup the Plot (Grid of 4x2 = 8 images)
    rows, cols = 4, 2
    fig, axes = plt.subplots(rows, cols, figsize=(16, 20))
    fig.suptitle('KRISP Model Predictions (OK-VQA)', fontsize=16)
    
    # Flatten axes for easy iteration
    axes = axes.flatten()
    
    count = 0
    for q in questions_list:
        q_id = q['question_id']
        
        if q_id in pred_map:
            # Get Info
            question_text = q['question']
            answer_text = pred_map[q_id]
            image_id = q['image_id']
            image_filename = f"COCO_val2014_{int(image_id):012d}.jpg"
            full_image_path = os.path.join(image_root_dir, image_filename)

            # Check if image exists
            if not os.path.exists(full_image_path):
                print(f"Image not found: {full_image_path}")
                continue

            # 3. Display on Subplot
            ax = axes[count]
            try:
                img = mpimg.imread(full_image_path)
                ax.imshow(img)
            except Exception as e:
                print(f"Error reading image {image_filename}: {e}")
                continue

            # Remove axis ticks
            ax.axis('off')

            # Wrap text so it doesn't go off screen
            wrapped_q = "\n".join(textwrap.wrap(f"Q: {question_text}", width=40))
            label_text = f"{wrapped_q}\n\nPRED: {answer_text}"
            
            # Add text to the plot (Side or Bottom)
            ax.set_title(label_text, fontsize=12, loc='left', color='blue', fontweight='bold')

            count += 1
            if count >= (rows * cols):
                break
    
    # 4. Save and Show
    output_path = "./predictions_grid.png"
    plt.tight_layout(rect=[0, 0.03, 1, 0.95]) # Adjust layout
    plt.savefig(output_path)
    print(f"\n[Success] Visualization saved to: {output_path}")
    print("You can download this file to view the images and answers.")

    # Optional: Try to open window if supported
    try:
        plt.show()
    except:
        pass

if __name__ == "__main__":
    visualize_data()